```kotlin package com.example.audioambiance.playback import android.app.NotificationChannel import android.app.NotificationManager import android.app.PendingIntent import android.app.Service import android.content.Context import android.content.Intent import android.hardware.Sensor import android.hardware.SensorEvent import android.hardware.SensorEventListener import android.hardware.SensorManager import android.os.Build import android.os.Handler import android.os.IBinder import android.os.Looper import androidx.core.app.NotificationCompat import com.example.audioambiance.MainActivity import com.google.android.exoplayer2.ExoPlayer import com.google.android.exoplayer2.MediaItem import com.google.android.exoplayer2.Player import android.widget.Toast import android.R class AudioPlaybackService : Service(), Player.Listener, SensorEventListener { private var bookPlayer: ExoPlayer? = null private var ambiancePlayer: ExoPlayer? = null private val NOTIFICATION_CHANNEL_ID = "audio_playback_channel" private val NOTIFICATION_ID = 1 // --- Pause Intelligente --- private lateinit var sensorManager: SensorManager private var accelerometer: Sensor? = null private val inactivityHandler = Handler(Looper.getMainLooper()) private val INACTIVITY_DELAY_MS = 30 * 60 * 1000L // 30 minutes private val inactivityRunnable = Runnable { if (bookPlayer?.isPlaying == true) { bookPlayer?.pause() Toast.makeText(this, "Pause Intelligente: Inactivité détectée.", Toast.LENGTH_LONG).show() updateNotification() } } // --- Fin Pause Intelligente --- override fun onCreate() { super.onCreate() createNotificationChannel() // Initialisation des ExoPlayer bookPlayer = ExoPlayer.Builder(this).build().apply { addListener(this@AudioPlaybackService) repeatMode = Player.REPEAT_MODE_OFF } ambiancePlayer = ExoPlayer.Builder(this).build().apply { addListener(this@AudioPlaybackService) repeatMode = Player.REPEAT_MODE_ALL } // --- Initialisation des Capteurs --- sensorManager = getSystemService(Context.SENSOR_SERVICE) as SensorManager accelerometer = sensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER) accelerometer?.let { sensorManager.registerListener(this, it, SensorManager.SENSOR_DELAY_NORMAL) } startForeground(NOTIFICATION_ID, buildNotification()) } override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int { when (intent?.action) { "ACTION_PLAY" -> { handlePlayCommand() } "ACTION_PAUSE" -> { bookPlayer?.pause() ambiancePlayer?.pause() inactivityHandler.removeCallbacks(inactivityRunnable) } "ACTION_SEEK_FORWARD" -> { bookPlayer?.seekToRelative(30000L) } "ACTION_SEEK_BACKWARD" -> { bookPlayer?.seekToRelative(-15000L) } } updateNotification() return START_STICKY } private fun handlePlayCommand() { if (bookPlayer?.playbackState == Player.STATE_IDLE) { // Utilisation de sources de test publiques val exampleBook = MediaItem.fromUri("https://storage.googleapis.com/exoplayer-test-media-01/mp3/a.mp3") bookPlayer?.setMediaItem(exampleBook) bookPlayer?.prepare() val exampleAmbiance = MediaItem.fromUri("https://storage.googleapis.com/exoplayer-test-media-01/m4a/android_res_raw_prop_stereo.m4a") ambiancePlayer?.setMediaItem(exampleAmbiance) ambiancePlayer?.prepare() } bookPlayer?.play() ambiancePlayer?.play() inactivityHandler.removeCallbacks(inactivityRunnable) inactivityHandler.postDelayed(inactivityRunnable, INACTIVITY_DELAY_MS) } // --- SensorEventListener Implementation (Pause Intelligente) --- override fun onSensorChanged(event: SensorEvent?) { if (event?.sensor?.type == Sensor.TYPE_ACCELEROMETER && bookPlayer?.isPlaying == true) { val x = event.values[0] val y = event.values[1] val z = event.values[2] val acceleration = Math.sqrt((x * x + y * y + z * z).toDouble()).toFloat() val threshold = 0.5f if (acceleration > (SensorManager.GRAVITY_EARTH + threshold)
